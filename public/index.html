<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20100%20100%27%3E%3Ctext%20y%3D%27.9em%27%20font-size%3D%2790%27%3E%F0%9F%87%B3%F0%9F%87%B1%3C/text%3E%3C/svg%3E">
    <title>lofi ATC Â· Amsterdam Schiphol</title>

    <meta property="og:title" content="Lo-fi Air Traffic Control Â· Amsterdam Schiphol">
    <meta property="og:description" content="Live ATC radio from Schiphol mixed with lofi beats. Real-time arrivals. Chill vibes.">
    <meta property="og:image" content="https://lofi-atc-ams.co-evolve.nl/lofiatcams-og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lofi-atc-ams.co-evolve.nl">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Lo-fi Air Traffic Control Â· Amsterdam Schiphol">
    <meta name="twitter:description" content="Live ATC radio from Schiphol mixed with lofi beats. Real-time arrivals. Chill vibes.">
    <meta name="twitter:image" content="https://lofi-atc-ams.co-evolve.nl/lofiatcams-og-image.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0e1a;
            --bg-card: #0d1225;
            --bg-card-hover: #111833;
            --text: #c8d6e5;
            --text-dim: #5a6a7a;
            --amber: #f0a500;
            --green: #4ade80;
            --blue: #60a5fa;
            --red: #f87171;
            --glow: rgba(96, 165, 250, 0.15);
            --font-body: 'Inter', sans-serif;
            --font-mono: 'Space Mono', monospace;
        }

        html { font-size: 16px; }

        body {
            font-family: var(--font-body);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated gradient background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0a0e1a 0%, #0f1b3d 25%, #0a0e1a 50%, #121a35 75%, #0a0e1a 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            z-index: -1;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* â”€â”€ Hero â”€â”€ */
        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .hero-clock {
            font-family: var(--font-mono);
            font-size: 1rem;
            color: var(--text-dim);
            letter-spacing: 0.2em;
            margin-bottom: 1rem;
        }

        .hero h1 {
            font-family: var(--font-mono);
            font-size: clamp(1.5rem, 5vw, 2.8rem);
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }

        .hero h1 span { color: var(--blue); }

        .hero-sub {
            font-size: 0.95rem;
            color: var(--text-dim);
            margin-bottom: 2.5rem;
            font-weight: 300;
        }

        /* â”€â”€ Audio Controls â”€â”€ */
        .audio-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
            width: 100%;
            max-width: 400px;
        }

        .play-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.08);
            color: var(--blue);
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .play-btn:hover {
            background: rgba(96, 165, 250, 0.15);
            border-color: var(--blue);
            box-shadow: 0 0 30px rgba(96, 165, 250, 0.2);
            transform: scale(1.05);
        }

        .play-btn.playing { border-color: var(--green); color: var(--green); background: rgba(74, 222, 128, 0.08); }

        .atc-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            font-family: var(--font-mono);
            color: var(--text-dim);
        }

        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
            transition: background 0.3s;
        }

        .status-dot.connected { background: var(--green); box-shadow: 0 0 8px rgba(74, 222, 128, 0.5); }
        .status-dot.error { background: var(--red); box-shadow: 0 0 8px rgba(248, 113, 113, 0.5); }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 280px;
        }

        .volume-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-dim);
            min-width: 28px;
            text-align: right;
        }

        .volume-icon { font-size: 1rem; color: var(--text-dim); cursor: pointer; }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.1);
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: var(--blue);
            cursor: pointer;
            box-shadow: 0 0 6px rgba(96, 165, 250, 0.4);
        }

        .volume-slider::-moz-range-thumb {
            width: 14px; height: 14px;
            border-radius: 50%;
            background: var(--blue);
            border: none;
            cursor: pointer;
        }

        .lofi-section {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .lofi-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .lofi-embed {
            border-radius: 12px;
            overflow: hidden;
            opacity: 0.85;
            transition: opacity 0.3s;
        }

        .lofi-embed:hover { opacity: 1; }

        /* â”€â”€ Scroll indicator â”€â”€ */
        .scroll-hint {
            position: absolute;
            bottom: 2rem;
            animation: bob 2s ease-in-out infinite;
            color: var(--text-dim);
            font-size: 1.5rem;
        }

        @keyframes bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(8px); }
        }

        /* â”€â”€ Content â”€â”€ */
        .content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem 1.5rem 4rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .content {
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }
        }

        /* â”€â”€ FIDS Flight Board â”€â”€ */
        .fids {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.04);
            position: relative;
        }

        /* Scan-line effect */
        .fids::after {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.08) 2px,
                rgba(0,0,0,0.08) 4px
            );
            pointer-events: none;
            z-index: 1;
        }

        .fids-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .fids-title {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--amber);
        }

        .fids-refresh {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .refresh-spinner {
            display: inline-block;
            width: 10px; height: 10px;
            border: 1.5px solid var(--text-dim);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .refresh-spinner.active { opacity: 1; }

        @keyframes spin { to { transform: rotate(360deg); } }

        .fids-columns {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 100px;
            padding: 0.6rem 1.25rem;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .fids-row {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 100px;
            padding: 0.75rem 1.25rem;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: background 0.2s;
            animation: fadeRow 0.5s ease;
        }

        @keyframes fadeRow {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fids-row:hover { background: var(--bg-card-hover); }

        .fids-row .time {
            color: var(--amber);
            font-weight: 700;
            text-shadow: 0 0 8px rgba(240, 165, 0, 0.3);
        }

        .fids-row .flight-num { color: #fff; font-weight: 700; }
        .fids-row .origin { color: var(--text); }

        .status-badge {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 4px;
            text-align: center;
            letter-spacing: 0.05em;
            width: fit-content;
        }

        .status-landed { background: rgba(74, 222, 128, 0.15); color: var(--green); }
        .status-expected { background: rgba(96, 165, 250, 0.15); color: var(--blue); }
        .status-delayed { background: rgba(240, 165, 0, 0.15); color: var(--amber); }
        .status-cancelled { background: rgba(248, 113, 113, 0.15); color: var(--red); }

        .fids-empty {
            padding: 3rem;
            text-align: center;
            color: var(--text-dim);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .fids-time-window {
            padding: 0.5rem 1.25rem;
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-dim);
            border-top: 1px solid rgba(255,255,255,0.04);
            text-align: center;
        }

        /* â”€â”€ Radar â”€â”€ */
        .radar-panel {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .radar-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--amber);
        }

        .radar-iframe-wrap {
            position: relative;
            width: 100%;
            padding-bottom: 80%;
        }

        @media (min-width: 1024px) {
            .radar-iframe-wrap {
                padding-bottom: 100%;
            }
            .radar-panel {
                position: sticky;
                top: 2rem;
            }
        }

        .radar-iframe-wrap iframe {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border: none;
            filter: brightness(0.85) saturate(0.9);
        }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 640px) {
            .fids-columns, .fids-row {
                grid-template-columns: 60px 1fr 1fr 80px;
                font-size: 0.75rem;
                padding: 0.6rem 0.75rem;
            }
            .hero h1 { font-size: 1.4rem; }
        }

        /* Selection */
        ::selection { background: rgba(96, 165, 250, 0.3); color: #fff; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Hero -->
    <section class="hero">
        <div class="hero-clock" id="clock">00:00 UTC</div>
        <h1>lofi ATC Â· <span>schiphol</span></h1>
        <p class="hero-sub">live air traffic control Ã— lofi beats Ã— amsterdam</p>

        <div class="audio-panel">
            <button class="play-btn" id="playBtn" title="Start listening â€” ATC + lofi beats">â–¶</button>
            <div class="atc-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">tap to start listening</span>
            </div>
            <div class="volume-control">
                <span class="volume-icon" id="volumeIcon">ðŸ”Š</span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="25">
                <span class="volume-label" id="volumeLabel">25%</span>
            </div>
            <div class="lofi-section">
                <span class="lofi-label">lofi beats</span>
                <div class="lofi-embed" id="lofiEmbed">
                    <!-- YouTube iframe injected on play -->
                </div>
            </div>
        </div>

        <div class="scroll-hint">â†“</div>
    </section>

    <!-- Content -->
    <main class="content">
        <!-- Flight Board -->
        <section class="fids">
            <div class="fids-header">
                <span class="fids-title">Arrivals Â· AMS</span>
                <span class="fids-refresh">
                    <span class="refresh-spinner" id="refreshSpinner"></span>
                    <span id="refreshText">updated just now</span>
                </span>
            </div>
            <div class="fids-columns">
                <span>Time</span>
                <span>Flight</span>
                <span>Origin</span>
                <span>Status</span>
            </div>
            <div id="flightBoard">
                <div class="fids-empty">Loading arrivals...</div>
            </div>
            <div class="fids-time-window" id="timeWindow"></div>
        </section>

        <!-- Radar -->
        <section class="radar-panel">
            <div class="radar-header">Live Radar Â· Schiphol</div>
            <div class="radar-iframe-wrap">
                <iframe id="radarFrame"
                    src=""
                    loading="lazy">
                </iframe>
            </div>
        </section>
    </main>

    <audio id="atcAudio" preload="none"></audio>

    <script>
    (function() {
        'use strict';

        // â”€â”€ ATC stream URLs (original working URLs) â”€â”€
        const ATC_STREAMS = [
            'https://d.liveatc.net/eham_app_119055',
            'https://d.liveatc.net/eham_app',
            'https://d.liveatc.net/eham_twr',
        ];

        // â”€â”€ Clock â”€â”€
        function updateClock() {
            const now = new Date();
            const utc = now.toUTCString().slice(17, 22);
            const local = now.toLocaleTimeString('nl-NL', { timeZone: 'Europe/Amsterdam', hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock').textContent = `${local} AMS Â· ${utc} UTC`;
        }
        updateClock();
        setInterval(updateClock, 10000);

        // â”€â”€ ATC Audio â”€â”€
        const audio = document.getElementById('atcAudio');
        const playBtn = document.getElementById('playBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeLabel = document.getElementById('volumeLabel');
        const volumeIcon = document.getElementById('volumeIcon');
        const lofiEmbed = document.getElementById('lofiEmbed');
        let isPlaying = false;
        let currentStreamIndex = 0;
        let lofiStarted = false;

        audio.volume = 0.25;

        function tryStream(index) {
            if (index >= ATC_STREAMS.length) {
                statusDot.className = 'status-dot error';
                statusText.textContent = 'all ATC streams unavailable';
                playBtn.textContent = 'â–¶';
                playBtn.classList.remove('playing');
                isPlaying = false;
                return;
            }

            currentStreamIndex = index;
            const url = ATC_STREAMS[index] + '?nocache=' + Date.now();
            statusText.textContent = 'connecting...';

            audio.src = url;
            audio.load();
            audio.play().then(() => {
                playBtn.textContent = 'â¸';
                playBtn.classList.add('playing');
                statusDot.className = 'status-dot connected';
                const streamName = ATC_STREAMS[index].split('/').pop().split('?')[0].toUpperCase().replace(/_/g, ' ');
                statusText.textContent = 'live Â· ' + streamName;
                isPlaying = true;

                // Start YouTube lofi on first play (user gesture context)
                if (!lofiStarted) {
                    startLofi();
                    lofiStarted = true;
                }
            }).catch(() => {
                // Try next stream
                tryStream(index + 1);
            });
        }

        function startLofi() {
            const randomStart = Math.floor(Math.random() * 7200);
            lofiEmbed.innerHTML = `<iframe width="300" height="60"
                src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&loop=1&start=${randomStart}"
                title="lofi hip hop radio"
                allow="autoplay; encrypted-media"
                allowfullscreen
                style="border:none; border-radius:8px;">
            </iframe>`;
        }

        playBtn.addEventListener('click', () => {
            if (isPlaying) {
                audio.pause();
                playBtn.textContent = 'â–¶';
                playBtn.classList.remove('playing');
                statusDot.className = 'status-dot';
                statusText.textContent = 'paused';
                isPlaying = false;
            } else {
                tryStream(0);
            }
        });

        audio.addEventListener('error', () => {
            // Try next stream on error
            if (isPlaying) {
                tryStream(currentStreamIndex + 1);
            }
        });

        // Reconnect if stream ends
        audio.addEventListener('ended', () => {
            if (isPlaying) {
                setTimeout(() => tryStream(0), 2000);
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            const vol = e.target.value / 100;
            audio.volume = vol;
            volumeLabel.textContent = e.target.value + '%';
            volumeIcon.textContent = vol === 0 ? 'ðŸ”‡' : vol < 0.4 ? 'ðŸ”‰' : 'ðŸ”Š';
        });

        // â”€â”€ Radar iframe with live view (no showTrace for live) â”€â”€
        function setRadarUrl() {
            document.getElementById('radarFrame').src =
                'https://globe.adsbexchange.com/?icao=&lat=52.309&lon=4.764&zoom=10.5&hideButtons';
        }
        setRadarUrl();

        // â”€â”€ Time helpers â”€â”€
        function getNowAms() {
            // Get current time in Amsterdam timezone
            const str = new Date().toLocaleString('en-US', { timeZone: 'Europe/Amsterdam' });
            return new Date(str);
        }

        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        // â”€â”€ Render flights â”€â”€
        function renderFlights(flights) {
            const board = document.getElementById('flightBoard');
            const timeWindowEl = document.getElementById('timeWindow');
            if (!flights || flights.length === 0) {
                board.innerHTML = '<div class="fids-empty">No arrivals in this time window</div>';
                timeWindowEl.textContent = '';
                return;
            }

            const now = getNowAms();
            const nowMins = now.getHours() * 60 + now.getMinutes();

            // Filter: no more than 5 min in the past, max 30 min in the future
            const filtered = flights.filter(f => {
                if (!f.time || f.time === 'â€”') return false;
                const flightMins = timeToMinutes(f.time);
                const diff = flightMins - nowMins;
                // Handle midnight crossing
                const adjustedDiff = diff < -720 ? diff + 1440 : diff > 720 ? diff - 1440 : diff;
                return adjustedDiff >= -5 && adjustedDiff <= 30;
            });

            if (filtered.length === 0) {
                board.innerHTML = '<div class="fids-empty">No arrivals in the next 30 minutes</div>';
                const fromTime = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
                const toDate = new Date(now.getTime() + 30 * 60000);
                const toTime = String(toDate.getHours()).padStart(2,'0') + ':' + String(toDate.getMinutes()).padStart(2,'0');
                timeWindowEl.textContent = `showing ${fromTime} â€“ ${toTime} AMS`;
                return;
            }

            board.innerHTML = filtered.map((f, i) => {
                const statusClass = mapStatus(f.status);
                const statusLabel = mapStatusLabel(f.status);
                return `
                <div class="fids-row" style="animation-delay: ${i * 0.04}s">
                    <span class="time">${f.time}</span>
                    <span class="flight-num">${f.flight}</span>
                    <span class="origin">${f.origin}</span>
                    <span class="status-badge ${statusClass}">${statusLabel}</span>
                </div>`;
            }).join('');

            const fromTime = String(Math.max(0, now.getHours() * 60 + now.getMinutes() - 5)).toString();
            const hFrom = String(now.getHours()).padStart(2,'0');
            const mFrom = String(Math.max(0, now.getMinutes() - 5)).padStart(2,'0');
            const toDate = new Date(now.getTime() + 30 * 60000);
            const hTo = String(toDate.getHours()).padStart(2,'0');
            const mTo = String(toDate.getMinutes()).padStart(2,'0');
            timeWindowEl.textContent = `showing arrivals Â· now â€“ ${hTo}:${mTo} AMS Â· ${filtered.length} flights`;
        }

        function mapStatus(raw) {
            if (!raw) return 'status-expected';
            const s = raw.toUpperCase();
            if (s === 'ARR' || s === 'LND' || s === 'LANDED') return 'status-landed';
            if (s === 'DEL' || s === 'DELAYED') return 'status-delayed';
            if (s === 'CNX' || s === 'CANCELLED') return 'status-cancelled';
            return 'status-expected';
        }

        function mapStatusLabel(raw) {
            if (!raw) return 'expected';
            const s = raw.toUpperCase();
            if (s === 'ARR' || s === 'LND' || s === 'LANDED') return 'landed';
            if (s === 'DEL' || s === 'DELAYED') return 'delayed';
            if (s === 'CNX' || s === 'CANCELLED') return 'cancelled';
            if (s === 'EXP' || s === 'EXPECTED') return 'expected';
            return raw.toLowerCase();
        }

        // â”€â”€ Mock flights fallback â”€â”€
        function generateMockFlights() {
            const now = getNowAms();
            const base = now.getHours() * 60 + now.getMinutes();
            const airlines = [
                { code: 'KL', origins: ['London Heathrow', 'Paris CDG', 'Frankfurt', 'Copenhagen', 'Oslo'] },
                { code: 'TK', origins: ['Istanbul'] },
                { code: 'DL', origins: ['New York JFK', 'Atlanta'] },
                { code: 'BA', origins: ['London City', 'London Gatwick'] },
                { code: 'AF', origins: ['Paris CDG', 'Nice'] },
                { code: 'LH', origins: ['Frankfurt', 'Munich'] },
                { code: 'EY', origins: ['Abu Dhabi'] },
                { code: 'UA', origins: ['Chicago', 'Washington'] },
            ];
            const flights = [];
            for (let i = -3; i < 35; i += 3) {
                const mins = base + i;
                const h = String(Math.floor(((mins % 1440) + 1440) % 1440 / 60)).padStart(2,'0');
                const m = String(((mins % 60) + 60) % 60).padStart(2,'0');
                const al = airlines[Math.floor(Math.random() * airlines.length)];
                flights.push({
                    time: `${h}:${m}`,
                    flight: `${al.code}${Math.floor(Math.random() * 9000) + 1000}`,
                    origin: al.origins[Math.floor(Math.random() * al.origins.length)],
                    status: i < 0 ? 'landed' : (Math.random() > 0.85 ? 'delayed' : 'expected'),
                });
            }
            return flights;
        }

        // â”€â”€ Fetch flights â”€â”€
        let lastRefresh = Date.now();
        let cachedFlights = null;

        function fetchFlights() {
            const spinner = document.getElementById('refreshSpinner');
            const refreshText = document.getElementById('refreshText');
            spinner.classList.add('active');
            refreshText.textContent = 'updating...';

            fetch('/.netlify/functions/arrivals')
                .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
                .then(data => {
                    const raw = data.flights || data || [];
                    const flights = raw.map(f => {
                        // Get time in AMS timezone from scheduleDateTime
                        let time = f.scheduleTime?.slice(0, 5) || '';
                        if (f.scheduleDateTime) {
                            const d = new Date(f.scheduleDateTime);
                            const ams = new Date(d.toLocaleString('en-US', { timeZone: 'Europe/Amsterdam' }));
                            time = String(ams.getHours()).padStart(2,'0') + ':' + String(ams.getMinutes()).padStart(2,'0');
                        }
                        return {
                            time,
                            flight: f.flightName || '',
                            origin: f.cityInfo?.city || (f.route?.destinations || [])[0] || '',
                            status: (f.publicFlightState?.flightStates || [])[0] || 'expected',
                        };
                    });

                    cachedFlights = flights.length > 0 ? flights : null;
                    renderFlights(cachedFlights || generateMockFlights());
                    lastRefresh = Date.now();
                    spinner.classList.remove('active');
                    refreshText.textContent = 'updated just now';
                })
                .catch(() => {
                    renderFlights(cachedFlights || generateMockFlights());
                    spinner.classList.remove('active');
                    refreshText.textContent = cachedFlights ? 'using cached data' : 'demo data';
                });
        }

        fetchFlights();
        setInterval(fetchFlights, 5 * 60 * 1000);

        // Re-render every 60s to keep the time window sliding
        setInterval(() => {
            renderFlights(cachedFlights || generateMockFlights());
        }, 60000);

        // Update "updated X min ago" text
        setInterval(() => {
            const mins = Math.floor((Date.now() - lastRefresh) / 60000);
            if (mins > 0) {
                document.getElementById('refreshText').textContent = `updated ${mins}m ago`;
            }
        }, 30000);

    })();
    </script>
</body>
</html>
