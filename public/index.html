<!doctype html>
<html lang="en">
<head>
    <!-- REMOVED Simple Analytics Script -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Embed NL Flag SVG as Favicon -->
    <!-- Updated: URL-encoded SVG for better browser compatibility -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20100%20100%27%3E%3Ctext%20y%3D%27.9em%27%20font-size%3D%2790%27%3E%F0%9F%87%B3%F0%9F%87%B1%3C/text%3E%3C/svg%3E">
    <title>lofi air traffic control üá≥üá± amsterdam edition</title>
    
    <!-- Add Open Graph metadata -->
    <meta property="og:title" content="Lo-fi Air Traffic Control üá≥üá± Amsterdam Edition">
    <meta property="og:description" content="Listen to live air traffic control radio from Amsterdam Schiphol Airport (AMS) mixed with Lo-fi Hip Hop beats. Relax to real-time ATC chatter with a calming lofi soundtrack."> 
    <meta property="og:image" content="./lofiatcams-og-image.png"> <!-- TODO: Add actual OG image -->
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com/lofiatcams"> <!-- TODO: Change OG URL -->
    
    <!-- Twitter Card metadata -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Lo-fi Air Traffic Control üá≥üá± Amsterdam Edition"> 
    <meta name="twitter:description" content="Listen to live air traffic control radio from Amsterdam Schiphol Airport (AMS) mixed with Lo-fi Hip Hop beats. A relaxing ambient experience combining real-time ATC with calming music."> 
    <meta name="twitter:image" content="./lofiatcams-og-image.png"> <!-- TODO: Add actual Twitter image -->

    <!-- Add jQuery library -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    
    <style>
        :root {
            --primary-color: #0f2b5b;
            --secondary-color: #ff4b1f;
            --accent-color: #4FADE0;
            --text-color: #333;
            --light-bg: #f9f9f9;
            --dark-bg: #1a1a1a;
            --border-color: #e1e7ef;
            --grid-gap: 16px;
            --card-radius: 12px;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        /* Time-based themes */
        body.morning {
            --primary-color: #ff8c42;
            --secondary-color: #ffca3a;
            --bg-gradient: linear-gradient(135deg, #ffdb58, #ff8c42);
        }
        
        body.afternoon {
            --primary-color: #0f2b5b;
            --secondary-color: #4cc9f0;
            --bg-gradient: linear-gradient(135deg, #4cc9f0, #0f2b5b);
        }
        
        body.evening {
            --primary-color: #8338ec;
            --secondary-color: #ff006e;
            --bg-gradient: linear-gradient(135deg, #ff006e, #8338ec);
        }
        
        body.night {
            --primary-color: #212f45;
            --secondary-color: #006466;
            --bg-gradient: linear-gradient(135deg, #006466, #212f45);
            --text-color: #e1e1e1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            transition: background-color 1s ease, color 1s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        header {
            background: var(--bg-gradient, linear-gradient(135deg, var(--primary-color), var(--secondary-color)));
            color: white;
            padding: 24px;
            text-align: center;
            border-radius: 0 0 var(--card-radius) var(--card-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 24px;
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .time-display {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--grid-gap);
            margin-bottom: 24px;
        }
        
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: 1fr 2fr;
            }
            
            .arrivals-card {
                grid-column: 2;
                grid-row: 1;
            }
            
            .audio-card {
                grid-column: 1;
                grid-row: 1;
            }
        }
        
        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: 1fr 2fr;
            }
        }
        
        .card {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background: var(--primary-color);
            color: white;
            padding: 16px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 16px;
        }
        
        .audio-player {
            width: 100%;
            margin-top: 16px;
        }
        
        .flights-container {
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        
        .flights-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .flights-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .flights-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        .flight {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .flight:hover {
            background-color: rgba(79, 173, 224, 0.05);
        }
        
        .flight:last-child {
            border-bottom: none;
        }
        
        .flight-datetime {
            min-width: 120px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .flight-time {
            font-weight: bold;
            font-size: 1.1rem;
            color: white;
        }
        
        .flight-date {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .flight-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 20px;
            min-width: 80px;
            text-align: center;
        }
        
        .status-landed {
            background-color: #DCEDC8;
            color: #558B2F;
        }
        
        .status-expected {
            background-color: #E1F5FE;
            color: #0288D1;
        }
        
        .status-delayed {
            background-color: #FFE0B2;
            color: #EF6C00;
        }
        
        .status-cancelled {
            background-color: #FFCDD2;
            color: #C62828;
        }
        
        .flight-airline {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .flight-origin {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }
        
        .country-flag {
            width: 24px;
            height: auto;
            margin-right: 8px;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .arrivals-info {
            background-color: var(--light-bg);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .refresh-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        
        .refresh-button:hover {
            background-color: var(--secondary-color);
        }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        footer {
            background: var(--primary-color);
            color: white;
            padding: 16px;
            text-align: center;
            margin-top: 24px;
        }
        
        footer a {
            color: white;
            text-decoration: underline;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            color: var(--primary-color);
        }
        
        .loading-spinner {
            border: 4px solid rgba(15, 43, 91, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Dark mode */
        @media (prefers-color-scheme: dark) {
            body:not(.morning):not(.afternoon):not(.evening):not(.night) {
                background-color: var(--dark-bg);
                color: #e1e1e1;
            }
            
            .card {
                background: #2a2a2a;
                color: #e1e1e1;
            }

            .flight:hover {
                background-color: #333;
            }

            .flight {
                border-bottom: 1px solid #444;
            }
        }
        
        /* Play overlay */
        .play-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .play-button {
            color: white;
            text-align: center;
            padding: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .play-button .icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .play-button .text {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 1px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .play-button::after {
            content: "Click to mix live air traffic with lo-fi beats";
            display: block;
            font-size: 1rem;
            margin-top: 1rem;
            opacity: 0.8;
        }
        
        /* Debug panel styles */
        #debugPanel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.8);
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            z-index: 9999;
            display: none;
        }
        
        .debug-entry {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        /* Time window selector */
        .time-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }
        
        .time-btn {
            background: var(--light-bg);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 4px;
            padding: 8px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 80px;
            text-align: center;
        }
        
        .time-btn:hover {
            background-color: rgba(15, 43, 91, 0.1);
        }
        
        .time-btn.active {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        /* Advanced dropdown styles */
        .advanced-dropdown {
            margin-top: 20px;
        }
        
        .dropdown-header {
            background-color: var(--light-bg);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dropdown-content {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 0 0 4px 4px;
            margin-top: -1px;
            display: none;
        }
        
        .advanced-options {
            margin-top: 10px;
            font-size: 0.85rem;
        }
        
        .advanced-toggle {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
        }
        
        .advanced-params {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: var(--light-bg);
            border-radius: 4px;
        }
        
        .advanced-params label {
            display: block;
            margin-bottom: 5px;
        }
        
        .advanced-params input, .advanced-params select {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .apply-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
        }
        
        .status-indicator {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .status-indicator span {
            font-weight: bold;
        }

        .volume-control {
            margin-top: 16px;
        }
        .volume-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            appearance: none;
            background: var(--light-bg);
            outline: none;
            margin-top: 8px;
        }
        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }
        .atc-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }
        
        .audio-section {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Add play overlay -->
    <div id="playOverlay" class="play-overlay">
        <div class="play-button">
            <div class="icon">üá≥üá±</div> 
            <div class="text">Tap to start listening</div>
        </div>
    </div>
    
    <header>
        <h1>lofi air traffic control üá≥üá± Amsterdam Edition</h1>
        <p>Relax to Amsterdam's air traffic control, live flight arrivals, and lo-fi beats</p>
        <div class="time-display" id="currentTime"></div>
        <div class="status-indicator" id="dataStatus">Flight data: <span>Not loaded</span></div>
    </header>

    <div class="container">
        <div class="grid">
            <div class="card audio-card">
                <div class="card-header">
                    <span>üéß Live Air Traffic Control & üéµ Lo-Fi Beats</span>
                </div>
                <div class="card-body">
                    <div class="audio-section">
                        <p>Listen to live ATC communications from Amsterdam Schiphol Airport (EHAM) mixed with lo-fi beats.</p>
                        <audio class="audio-player" id="atcAudio" controls loop preload="auto" muted style="display: none;">
                            <source src="https://d.liveatc.net/eham_app_119055" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="volume-control">
                            <label for="atc-volume">ATC Volume: <span id="volume-value">20%</span></label>
                            <input type="range" id="atc-volume" min="0" max="100" value="20" class="volume-slider">
                        </div>
                        <div id="atc-status" class="atc-status">Waiting for user to start audio...</div>
                    </div>
                    
                    <div class="video-container">
                        <!-- Placeholder iframe that will be populated with random start time -->
                        <iframe id="youtubeFrame" 
                        frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>

                    <!-- Script to handle overlay and media playback -->
                    <script>
                      // Initialize with empty src, will be populated on user interaction
                      document.getElementById('youtubeFrame').removeAttribute('src');
                    </script>
                </div>
            </div>

            <div class="card arrivals-card">
                <div class="card-header">
                    <span>‚úàÔ∏è Live Arrivals</span>
                    <button class="refresh-button" id="refreshFlights">Refresh</button>
                </div>
                <div class="card-body">
                    <div class="flights-container" id="flightsContainer">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>Loading flights...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Radar view -->
        <div class="card radar-card">
            <div class="card-header">
                <span>üó∫Ô∏è Live Radar</span>
            </div>
            <div class="card-body">
                <div class="video-container">
                    <iframe src="https://globe.adsbexchange.com/?icao=&lat=52.31&lon=4.77&zoom=10.0&showTrace=2022-01-01&trackLabels&hideButtons&startTime=1641016800&endTime=1641103199&timeOffset=0&timestamp=1641060000" 
                    frameborder="0" allowfullscreen="true"></iframe>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>¬© 2025 Amsterdam Flight Vibe | ATC Audio from <a href="https://www.liveatc.net" target="_blank">LiveATC.net</a> | Radar data from <a href="https://www.adsbexchange.com" target="_blank">ADSBexchange</a> | Not affiliated with any official aviation authority</p>
    </footer>

    <script>
        // Get current time and display it
        function updateTime() {
            const now = new Date();
            const formattedTime = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            const formattedDate = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('currentTime').textContent = `${formattedDate}, ${formattedTime}`;
            
            // Update body class based on time of day
            const hour = now.getHours();
            const body = document.body;
            
            // Remove all time classes
            body.classList.remove('morning', 'afternoon', 'evening', 'night');
            
            // Add appropriate time class
            if (hour >= 5 && hour < 12) {
                body.classList.add('morning');
            } else if (hour >= 12 && hour < 18) {
                body.classList.add('afternoon');
            } else if (hour >= 18 && hour < 22) {
                body.classList.add('evening');
            } else {
                body.classList.add('night');
            }
        }
        
        // Debug function to show alerts
        function debugAlert(message) {
            console.log(message);
            // Create a floating message div instead of using alerts
            const debugDiv = document.createElement('div');
            debugDiv.style.position = 'fixed';
            debugDiv.style.bottom = '10px';
            debugDiv.style.right = '10px';
            debugDiv.style.backgroundColor = 'rgba(255,0,0,0.8)';
            debugDiv.style.color = 'white';
            debugDiv.style.padding = '10px';
            debugDiv.style.borderRadius = '5px';
            debugDiv.style.zIndex = '9999';
            debugDiv.textContent = message;
            document.body.appendChild(debugDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                document.body.removeChild(debugDiv);
            }, 5000);
        }
        
        // Restore the fetchFlights function
        async function fetchFlights() {
            const flightsContainer = document.getElementById('flightsContainer');
            const dataStatus = document.getElementById('dataStatus');
            
            if (dataStatus) {
                dataStatus.innerHTML = 'Flight data: <span>Loading...</span>';
            }
            
            if (!flightsContainer) {
                debugAlert("Flights container not found!");
                return;
            }
            
            flightsContainer.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading flights...</span>
                </div>
            `;
            
            try {
                let data;
                let flights = [];
                
                try {
                    console.log("Fetching current flights from API");
                    const response = await fetch('/.netlify/functions/arrivals');
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    data = await response.json();
                    flights = data.flights || [];
                    
                    // Sort flights by schedule time
                    flights.sort((a, b) => {
                        const timeA = a.scheduleTime || '00:00:00';
                        const timeB = b.scheduleTime || '00:00:00';
                        return timeA.localeCompare(timeB);
                    });
                    
                    console.log(`Received ${flights.length} flights from API`);
                    
                } catch (apiError) {
                    console.error('API Error:', apiError);
                    // Use mock data if API fails
                    flights = window.mockFlights || [];
                    data = { meta: { totalFlights: flights.length } };
                }
                
                if (!flights || flights.length === 0) {
                    flightsContainer.innerHTML = `
                        <div class="no-flights">
                            <p>No flights found.</p>
                            <button class="refresh-button" onclick="fetchFlights()">Refresh</button>
                        </div>
                    `;
                    return;
                }

                // Display current time information
                html = `
                    <div class="arrivals-info">
                        <strong>Current Arrivals</strong> - ${data.meta?.totalFlights || flights.length} flights
                    </div>`;
                
                // Improved airport code to country code mapping
                const airportToCountry = {
                    // Europe
                    'AMS': {code: 'nl', name: 'Amsterdam'},
                    'LHR': {code: 'gb', name: 'London Heathrow'},
                    'CDG': {code: 'fr', name: 'Paris Charles de Gaulle'},
                    'FRA': {code: 'de', name: 'Frankfurt'},
                    'MAD': {code: 'es', name: 'Madrid'},
                    'FCO': {code: 'it', name: 'Rome Fiumicino'},
                    'ATH': {code: 'gr', name: 'Athens'},
                    'VIE': {code: 'at', name: 'Vienna'},
                    'ZRH': {code: 'ch', name: 'Zurich'},
                    'OSL': {code: 'no', name: 'Oslo'},
                    'CPH': {code: 'dk', name: 'Copenhagen'},
                    'ARN': {code: 'se', name: 'Stockholm Arlanda'},
                    'HEL': {code: 'fi', name: 'Helsinki'},
                    'BRU': {code: 'be', name: 'Brussels'},
                    'LIS': {code: 'pt', name: 'Lisbon'},
                    'DUB': {code: 'ie', name: 'Dublin'},
                    'BUD': {code: 'hu', name: 'Budapest'},
                    'PRG': {code: 'cz', name: 'Prague'},
                    'WAW': {code: 'pl', name: 'Warsaw'},
                    'BRI': {code: 'it', name: 'Bari'},
                    
                    // Middle East
                    'DXB': {code: 'ae', name: 'Dubai'},
                    'DOH': {code: 'qa', name: 'Doha'},
                    'TLV': {code: 'il', name: 'Tel Aviv'},
                    'IST': {code: 'tr', name: 'Istanbul'},
                    
                    // Americas
                    'JFK': {code: 'us', name: 'New York JFK'},
                    'LAX': {code: 'us', name: 'Los Angeles'},
                    'ORD': {code: 'us', name: 'Chicago O\'Hare'},
                    'MIA': {code: 'us', name: 'Miami'},
                    'YYZ': {code: 'ca', name: 'Toronto'},
                    'YVR': {code: 'ca', name: 'Vancouver'},
                    'MEX': {code: 'mx', name: 'Mexico City'},
                    'GRU': {code: 'br', name: 'S√£o Paulo'},
                    
                    // Asia
                    'NRT': {code: 'jp', name: 'Tokyo Narita'},
                    'HND': {code: 'jp', name: 'Tokyo Haneda'},
                    'PEK': {code: 'cn', name: 'Beijing'},
                    'PVG': {code: 'cn', name: 'Shanghai Pudong'},
                    'HKG': {code: 'hk', name: 'Hong Kong'},
                    'SIN': {code: 'sg', name: 'Singapore'},
                    'BKK': {code: 'th', name: 'Bangkok'},
                    'KUL': {code: 'my', name: 'Kuala Lumpur'},
                    'DEL': {code: 'in', name: 'Delhi'},
                    'BOM': {code: 'in', name: 'Mumbai'},
                    
                    // Oceania
                    'SYD': {code: 'au', name: 'Sydney'},
                    'MEL': {code: 'au', name: 'Melbourne'},
                    'AKL': {code: 'nz', name: 'Auckland'},
                    
                    // Africa
                    'JNB': {code: 'za', name: 'Johannesburg'},
                    'CPT': {code: 'za', name: 'Cape Town'},
                    'CAI': {code: 'eg', name: 'Cairo'},
                    'ADD': {code: 'et', name: 'Addis Ababa'}
                };
                
                flights.forEach(flight => {
                    // Format time and date (assuming scheduleDateTime is available, fallback to scheduleTime)
                    let formattedTime = 'N/A';
                    let formattedDate = 'N/A';
                    let flightDateTime = null;
                    
                    if (flight.scheduleDateTime) {
                        // If we have full datetime, subtract one day
                        flightDateTime = new Date(flight.scheduleDateTime);
                        flightDateTime.setDate(flightDateTime.getDate() - 1);
                        formattedTime = flightDateTime.toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            hour12: true 
                        });
                        formattedDate = flightDateTime.toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric'
                        });
                    } else if (flight.scheduleTime) {
                        // If we only have time, use current date minus one day
                        flightDateTime = new Date();
                        flightDateTime.setDate(flightDateTime.getDate() - 1);
                        const timeStr = flight.scheduleTime;
                        const [hours, minutes] = timeStr.split(':');
                        flightDateTime.setHours(parseInt(hours), parseInt(minutes));
                        
                        formattedTime = flightDateTime.toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            hour12: true 
                        });
                        formattedDate = flightDateTime.toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric'
                        });
                    }

                    // Skip if flight time is in the past
                    const now = new Date();
                    if (flightDateTime && flightDateTime < now) {
                        return;
                    }
                    
                    // Determine flight status and style
                    let statusClass = 'status-expected';
                    let statusText = 'Expected';
                    let hasLanded = false;
                    let isCancelled = false;
                    
                    if (flight.publicFlightState && flight.publicFlightState.flightStates) {
                        const states = flight.publicFlightState.flightStates;
                        if (states.includes('ARR') || states.includes('LND')) {
                            statusClass = 'status-landed';
                            statusText = 'Landed';
                            hasLanded = true;
                        } else if (states.includes('DEL')) {
                            statusClass = 'status-delayed';
                            statusText = 'Delayed';
                        } else if (states.includes('CNX')) {
                            statusClass = 'status-cancelled';
                            statusText = 'Cancelled';
                            isCancelled = true;
                        }
                    }
                    
                    // Skip rendering landed flights and cancelled flights
                    if (hasLanded || isCancelled) {
                        return;
                    }
                    
                    // Get origin city and country code
                    const originCity = flight.route?.destinations?.[0] || 'Unknown';
                    const cityInfo = flight.cityInfo || {};
                    
                    // Use enhanced airport information
                    const fullOriginName = cityInfo.airportName 
                        ? `${cityInfo.city} - ${cityInfo.airportName}`
                        : originCity;
                    
                    // Get country code from cityInfo
                    const countryCode = cityInfo.country?.toLowerCase() || 'eu';
                    
                    // Get airline name and code
                    const airlineName = flight.prefixICAO || flight.flightName || 'Unknown';
                    const flightNumber = flight.flightNumber || '';
                    
                    // Create flag image HTML with enhanced alt text
                    const flagUrl = `https://flagcdn.com/w40/${countryCode}.png`;
                    const flagHtml = `<img src="${flagUrl}" 
                        alt="${cityInfo.country || countryCode}" 
                        title="${fullOriginName}"
                        class="country-flag" loading="lazy">`;
                    
                    // Create flight element with enhanced information
                    html += `
                        <div class="flight">
                            <div class="flight-datetime">
                                <div class="flight-time">${formattedTime}</div>
                                <div class="flight-date">${formattedDate}</div>
                            </div>
                            <div><span class="flight-status ${statusClass}">${statusText}</span></div>
                            <div>
                                <div class="flight-airline">${airlineName} ${flightNumber}</div>
                                <div class="flight-origin">${flagHtml} ${fullOriginName}</div>
                            </div>
                        </div>
                    `;
                });
                
                // Update status indicator with success
                if (dataStatus) {
                    const now = new Date();
                    const formattedTime = now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    dataStatus.innerHTML = `Flight data: <span>Updated at ${formattedTime}</span>`;
                }
                
                flightsContainer.innerHTML = html;
                
                // Safely remove time window related elements if they exist
                const timeButtons = document.querySelectorAll('.time-btn');
                if (timeButtons) {
                    timeButtons.forEach(btn => {
                        if (btn && btn.parentNode) {
                            btn.parentNode.removeChild(btn);
                        }
                    });
                }
                
                const advancedToggle = document.getElementById('advancedToggle');
                if (advancedToggle && advancedToggle.parentNode) {
                    advancedToggle.parentNode.removeChild(advancedToggle);
                }
                
                const advancedParams = document.getElementById('advancedParams');
                if (advancedParams && advancedParams.parentNode) {
                    advancedParams.parentNode.removeChild(advancedParams);
                }
                
            } catch (error) {
                console.error('Error fetching flights:', error);
                
                // Update status indicator with error
                if (dataStatus) {
                    dataStatus.innerHTML = 'Flight data: <span style="color:#ffcdd2">Error loading</span>';
                }
                
                flightsContainer.innerHTML = `
                    <div class="no-flights">
                        <p>Error loading flights data: ${error.message}</p>
                        <button class="refresh-button" onclick="fetchFlights()">Retry</button>
                    </div>
                `;
            }
        }
        
        // Define updateArrivalsBoard function for compatibility
        function updateArrivalsBoard() {
            // Call fetchFlights with auto time window selection
            fetchFlights();
        }
        
        // Initialize audio and video with direct plain JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded");
            
            // Update time immediately and then every minute
            updateTime();
            setInterval(updateTime, 60000);
            
            // Get elements directly with vanilla JS
            const overlay = document.getElementById('playOverlay');
            const audio = document.getElementById('atcAudio');
            const youtubeFrame = document.getElementById('youtubeFrame');
            const volumeSlider = document.getElementById('atc-volume');
            const volumeValue = document.getElementById('volume-value');
            
            if (!overlay) {
                console.error("Overlay element not found!");
            }
            
            if (!audio) {
                console.error("Audio element not found!");
            }
            
            if (!youtubeFrame) {
                console.error("YouTube iframe not found!");
            }
            
            // Set initial volume if elements exist
            if (audio && volumeSlider) {
                const initialVolume = volumeSlider.value / 100;
                audio.volume = initialVolume;
                console.log("Initial volume set to:", initialVolume);
            }
            
            // Volume control
            if (volumeSlider && volumeValue) {
                volumeSlider.addEventListener('input', function() {
                    if (audio) {
                        const volume = this.value / 100;
                        audio.volume = volume;
                        volumeValue.textContent = this.value + '%';
                        console.log("Volume changed to:", volume);
                    }
                });
            }
            
            // Initialize flight data
            setTimeout(function() {
                if (typeof fetchFlights === 'function') {
                    fetchFlights();
                } else {
                    console.error("fetchFlights function not found!");
                }
            }, 500);
            
            // Attach click handler to overlay with direct DOM method
            if (overlay) {
                overlay.addEventListener('click', function() {
                    console.log("Overlay clicked - starting media playback");
                    
                    // Hide overlay
                    overlay.style.display = 'none';
                    
                    // Update ATC status
                    const atcStatus = document.getElementById('atc-status');
                    if (atcStatus) {
                        atcStatus.textContent = "Connecting to live ATC...";
                    }
                    
                    // Start ATC audio
                    if (audio) {
                        audio.muted = false;
                        
                        const playPromise = audio.play();
                        
                        if (playPromise !== undefined) {
                            playPromise
                                .then(function() {
                                    console.log("ATC audio started successfully");
                                    
                                    if (atcStatus) {
                                        atcStatus.textContent = "Successfully connected to Schiphol Tower";
                                    }
                                    
                                    // Start YouTube with random position only after audio starts
                                    if (youtubeFrame) {
                                        const randomStartSeconds = Math.floor(Math.random() * 3600);
                                        const youtubeUrl = `https://www.youtube.com/embed/CLeZyIID9Bo?autoplay=1&loop=1&playlist=CLeZyIID9Bo&start=${randomStartSeconds}`;
                                        youtubeFrame.src = youtubeUrl;
                                        console.log("YouTube loaded with start time:", randomStartSeconds);
                                    }
                                })
                                .catch(function(error) {
                                    console.error("ATC audio error:", error);
                                    
                                    if (atcStatus) {
                                        atcStatus.textContent = "Error connecting to live ATC. You may need to retry or check your connection.";
                                        atcStatus.style.color = "#f44336";
                                    }
                                    
                                    // Try YouTube anyway if audio fails
                                    if (youtubeFrame) {
                                        const randomStartSeconds = Math.floor(Math.random() * 3600);
                                        const youtubeUrl = `https://www.youtube.com/embed/CLeZyIID9Bo?autoplay=1&loop=1&playlist=CLeZyIID9Bo&start=${randomStartSeconds}`;
                                        youtubeFrame.src = youtubeUrl;
                                        console.log("YouTube loaded after audio failure");
                                    }
                                });
                        } else {
                            console.error("Audio play() returned undefined");
                            
                            if (atcStatus) {
                                atcStatus.textContent = "Could not start ATC audio. Your browser may block autoplay.";
                                atcStatus.style.color = "#f44336";
                            }
                            
                            // Try YouTube anyway if audio method is undefined
                            if (youtubeFrame) {
                                const randomStartSeconds = Math.floor(Math.random() * 3600);
                                const youtubeUrl = `https://www.youtube.com/embed/CLeZyIID9Bo?autoplay=1&loop=1&playlist=CLeZyIID9Bo&start=${randomStartSeconds}`;
                                youtubeFrame.src = youtubeUrl;
                            }
                        }
                    }
                });
                
                console.log("Overlay click handler attached. Click the overlay to start media playback!");
            }
            
            // Attach refresh button handler
            const refreshButton = document.getElementById('refreshFlights');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    console.log("Refresh button clicked");
                    if (typeof fetchFlights === 'function') {
                        fetchFlights();
                    } else {
                        console.error("fetchFlights function not found!");
                    }
                });
            }
        });
        
        // Original jQuery code for backwards compatibility
        $(document).ready(function() {
            console.log("jQuery ready fired");
            
            // Most functionality now handled by the vanilla JS code above
        });
    </script>

    <!-- Add mock data for flights when API is unavailable -->
    <script>
        // Mock data for flights when API is unavailable
        window.mockFlights = [
            {
                scheduleTime: "12:15:00",
                flightNumber: "KL1234",
                prefixICAO: "KLM",
                route: { destinations: ["Paris (CDG)"] },
                publicFlightState: { flightStates: ["EXP"] },
                gate: "D23"
            },
            {
                scheduleTime: "12:45:00",
                flightNumber: "BA9012",
                prefixICAO: "BAW",
                route: { destinations: ["London (LHR)"] },
                publicFlightState: { flightStates: ["DEL"] },
                gate: "C12"
            },
            {
                scheduleTime: "13:05:00",
                flightNumber: "EK2134",
                prefixICAO: "UAE",
                route: { destinations: ["Dubai (DXB)"] },
                publicFlightState: { flightStates: ["EXP"] },
                gate: "G7"
            },
            {
                scheduleTime: "13:25:00",
                flightNumber: "AF6789",
                prefixICAO: "AFR",
                route: { destinations: ["Nice (NCE)"] },
                publicFlightState: { flightStates: ["EXP"] },
                gate: "B9"
            },
            {
                scheduleTime: "13:40:00",
                flightNumber: "SK1122",
                prefixICAO: "SAS",
                route: { destinations: ["Copenhagen (CPH)"] },
                publicFlightState: { flightStates: ["EXP"] },
                gate: "D17"
            },
            {
                scheduleTime: "14:15:00",
                flightNumber: "DL123",
                prefixICAO: "DAL",
                route: { destinations: ["New York (JFK)"] },
                publicFlightState: { flightStates: ["EXP"] },
                gate: "E4"
            }
        ];
    </script>
</body>
</html> 