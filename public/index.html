<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20100%20100%27%3E%3Ctext%20y%3D%27.9em%27%20font-size%3D%2790%27%3E%F0%9F%87%B3%F0%9F%87%B1%3C/text%3E%3C/svg%3E">
    <title>lofi ATC Â· Amsterdam Schiphol</title>

    <meta property="og:title" content="Lo-fi Air Traffic Control Â· Amsterdam Schiphol">
    <meta property="og:description" content="Live ATC radio from Schiphol mixed with lofi beats. Real-time arrivals. Chill vibes.">
    <meta property="og:url" content="https://lofi-atc-ams.co-evolve.nl">
    <meta name="twitter:card" content="summary_large_image">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #080c16;
            --bg-card: #0c1020;
            --bg-card-hover: #111833;
            --bg-header: #0a0f1c;
            --text: #c8d6e5;
            --text-dim: #4a5568;
            --amber: #f0a500;
            --green: #4ade80;
            --blue: #60a5fa;
            --red: #f87171;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'Space Mono', monospace;
        }

        html, body {
            height: 100%;
            font-family: var(--font-body);
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            font-size: 15px;
        }

        /* â”€â”€ App Shell â”€â”€ */
        .app {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
            height: 100dvh;
        }

        /* â”€â”€ Top Bar â”€â”€ */
        .topbar {
            background: var(--bg-header);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 0.5rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            min-height: 52px;
        }

        .topbar-brand {
            font-family: var(--font-mono);
            font-size: 0.95rem;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
        }

        .topbar-brand span { color: var(--blue); }

        .topbar-clock {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 0.1em;
        }

        .topbar-audio {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: auto;
        }

        .atc-btn {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.08);
            color: var(--blue);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .atc-btn:hover { background: rgba(96, 165, 250, 0.15); border-color: var(--blue); }
        .atc-btn.playing { border-color: var(--green); color: var(--green); background: rgba(74, 222, 128, 0.08); }

        .status-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--text-dim);
            display: inline-block;
        }
        .status-dot.connected { background: var(--green); box-shadow: 0 0 6px rgba(74, 222, 128, 0.6); }
        .status-dot.error { background: var(--red); }

        .vol-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .vol-icon {
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--text-dim);
        }

        .vol-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 70px;
            height: 3px;
            border-radius: 2px;
            background: rgba(255,255,255,0.1);
            outline: none;
            cursor: pointer;
        }

        .vol-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--blue);
            cursor: pointer;
        }

        .vol-slider::-moz-range-thumb {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--blue);
            border: none;
            cursor: pointer;
        }

        .lofi-mini {
            border-radius: 6px;
            overflow: hidden;
            line-height: 0;
        }

        .lofi-mini iframe { border: none; border-radius: 6px; }

        /* â”€â”€ Main Content â”€â”€ */
        .main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            overflow: hidden;
        }

        @media (max-width: 900px) {
            .main {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 40vh;
            }
        }

        /* â”€â”€ FIDS Flight Board â”€â”€ */
        .fids {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid rgba(255,255,255,0.04);
            position: relative;
        }

        .fids::after {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.04) 3px, rgba(0,0,0,0.04) 4px);
            pointer-events: none;
            z-index: 1;
        }

        .fids-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            background: var(--bg-card);
            flex-shrink: 0;
        }

        .fids-title {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--amber);
            text-shadow: 0 0 12px rgba(240, 165, 0, 0.2);
        }

        .fids-meta {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            display: inline-block;
            width: 8px; height: 8px;
            border: 1.5px solid var(--text-dim);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
        }
        .spinner.on { opacity: 1; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .fids-cols {
            display: grid;
            grid-template-columns: 52px 78px 140px 1fr 100px 90px;
            padding: 0.4rem 1rem;
            font-family: var(--font-mono);
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-dim);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            background: var(--bg-card);
            flex-shrink: 0;
        }

        .fids-scroll {
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.08) transparent;
        }

        .fids-scroll::-webkit-scrollbar { width: 4px; }
        .fids-scroll::-webkit-scrollbar-track { background: transparent; }
        .fids-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 2px; }

        .fids-row {
            display: grid;
            grid-template-columns: 52px 78px 140px 1fr 100px 90px;
            padding: 0.55rem 1rem;
            font-family: var(--font-mono);
            font-size: 0.78rem;
            border-bottom: 1px solid rgba(255,255,255,0.025);
            transition: background 0.15s;
            animation: fadeRow 0.4s ease;
            align-items: center;
        }

        .fids-row:hover { background: rgba(255,255,255,0.02); }

        @keyframes fadeRow {
            from { opacity: 0; transform: translateX(-6px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .fids-row .time {
            color: var(--amber);
            font-weight: 700;
            text-shadow: 0 0 8px rgba(240, 165, 0, 0.25);
        }

        .fids-row .flight { color: #fff; font-weight: 700; }

        .fids-row .carrier {
            color: var(--text);
            font-family: var(--font-body);
            font-size: 0.72rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fids-row .origin {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text);
            font-family: var(--font-body);
            font-size: 0.78rem;
        }

        .flag {
            width: 20px;
            height: 14px;
            border-radius: 2px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        .fids-row .aircraft {
            color: var(--text-dim);
            font-size: 0.68rem;
        }

        .badge {
            font-size: 0.58rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 3px;
            letter-spacing: 0.04em;
            width: fit-content;
        }

        .b-expected { background: rgba(96, 165, 250, 0.12); color: var(--blue); }
        .b-landed   { background: rgba(74, 222, 128, 0.12); color: var(--green); }
        .b-delayed  { background: rgba(240, 165, 0, 0.12); color: var(--amber); }
        .b-cancelled { background: rgba(248, 113, 113, 0.12); color: var(--red); }

        .fids-empty {
            padding: 3rem 1rem;
            text-align: center;
            color: var(--text-dim);
            font-family: var(--font-mono);
            font-size: 0.8rem;
        }

        .fids-footer {
            padding: 0.35rem 1rem;
            font-family: var(--font-mono);
            font-size: 0.58rem;
            color: var(--text-dim);
            border-top: 1px solid rgba(255,255,255,0.04);
            text-align: center;
            flex-shrink: 0;
            background: var(--bg-card);
        }

        /* â”€â”€ Radar â”€â”€ */
        .radar {
            position: relative;
            overflow: hidden;
            background: #000;
        }

        .radar iframe {
            width: 100%;
            height: 100%;
            border: none;
            filter: brightness(0.9) saturate(0.85);
        }

        .radar-label {
            position: absolute;
            top: 0.6rem;
            left: 0.8rem;
            font-family: var(--font-mono);
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--amber);
            background: rgba(0,0,0,0.7);
            padding: 4px 10px;
            border-radius: 4px;
            z-index: 10;
            pointer-events: none;
            text-shadow: 0 0 8px rgba(240, 165, 0, 0.3);
        }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 1100px) {
            .fids-cols, .fids-row {
                grid-template-columns: 50px 72px 120px 1fr 80px;
            }
            .fids-row .aircraft { display: none; }
            .fids-cols .col-aircraft { display: none; }
        }

        @media (max-width: 700px) {
            .topbar { padding: 0.4rem 0.75rem; gap: 0.75rem; }
            .lofi-mini { display: none; }
            .fids-cols, .fids-row {
                grid-template-columns: 48px 68px 1fr 72px;
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }
            .fids-row .carrier { display: none; }
            .fids-cols .col-carrier { display: none; }
            .fids-row .aircraft { display: none; }
            .fids-cols .col-aircraft { display: none; }
        }

        ::selection { background: rgba(96, 165, 250, 0.3); color: #fff; }
    </style>
</head>
<body>
<div class="app">
    <!-- Top Bar -->
    <header class="topbar">
        <div class="topbar-brand">lofi ATC Â· <span>schiphol</span></div>
        <div class="topbar-clock" id="clock"></div>
        <div class="topbar-audio">
            <button class="atc-btn" id="atcBtn">
                <span class="status-dot" id="dot"></span>
                <span id="atcLabel">â–¶ ATC</span>
            </button>
            <div class="vol-wrap">
                <span class="vol-icon" id="volIcon">ðŸ”‰</span>
                <input type="range" class="vol-slider" id="vol" min="0" max="100" value="25">
            </div>
            <div class="lofi-mini" id="lofiWrap"></div>
        </div>
    </header>

    <!-- Dashboard -->
    <div class="main">
        <!-- Flights -->
        <section class="fids">
            <div class="fids-bar">
                <span class="fids-title">âœˆ Arrivals Â· Amsterdam Schiphol</span>
                <span class="fids-meta">
                    <span class="spinner" id="spin"></span>
                    <span id="metaText">loading</span>
                </span>
            </div>
            <div class="fids-cols">
                <span>Time</span>
                <span>Flight</span>
                <span class="col-carrier">Airline</span>
                <span>Origin</span>
                <span class="col-aircraft">Aircraft</span>
                <span>Status</span>
            </div>
            <div class="fids-scroll" id="board"></div>
            <div class="fids-footer" id="footer"></div>
        </section>

        <!-- Radar -->
        <section class="radar">
            <span class="radar-label">Live Radar Â· AMS</span>
            <iframe id="radarFrame" src="" loading="lazy"></iframe>
        </section>
    </div>
</div>

<audio id="atcAudio" preload="none"></audio>

<script>
(function() {
    'use strict';

    // â”€â”€ Airline name map (ICAO prefix â†’ name) â”€â”€
    const AIRLINES = {
        KLM:'KLM Royal Dutch',TRA:'Transavia',HV:'Transavia',KLC:'KLM Cityhopper',
        BAW:'British Airways',DLH:'Lufthansa',AFR:'Air France',EZY:'easyJet',EJU:'easyJet',
        RYR:'Ryanair',FR:'Ryanair',VLG:'Vueling',IBE:'Iberia',TAP:'TAP Portugal',
        SAS:'SAS Scandinavian',FIN:'Finnair',AUA:'Austrian',SWR:'SWISS',BEL:'Brussels Airlines',
        LOT:'LOT Polish',CSA:'Czech Airlines',MAH:'MalÃ©v',THY:'Turkish Airlines',
        UAE:'Emirates',ETD:'Etihad',QTR:'Qatar Airways',SVA:'Saudia',RJA:'Royal Jordanian',
        ELY:'El Al',MEA:'Middle East Airlines',
        DAL:'Delta',AAL:'American',UAL:'United',
        ACA:'Air Canada',SIA:'Singapore Airlines',CPA:'Cathay Pacific',
        ANA:'All Nippon',JAL:'Japan Airlines',CCA:'Air China',CES:'China Eastern',CSN:'China Southern',
        KAL:'Korean Air',EVA:'EVA Air',MAS:'Malaysia Airlines',THA:'Thai Airways',GIA:'Garuda Indonesia',
        QFA:'Qantas',ETH:'Ethiopian',SAA:'South African',RAM:'Royal Air Maroc',
        NOS:'Neos',TUI:'TUI fly',CAI:'Corendon',SXS:'SunExpress',PGT:'Pegasus',WZZ:'Wizz Air',
        ICE:'Icelandair',NAX:'Norwegian',DY:'Norwegian',WIF:'WiderÃ¸e',
        TAR:'Tunisair',AMC:'Air Malta',AEE:'Aegean Airlines',OAL:'Olympic Air',ALK:'SriLankan',
    };

    // â”€â”€ Aircraft type map (IATA code â†’ readable) â”€â”€
    const AIRCRAFT = {
        '73H':'Boeing 737-800','738':'Boeing 737-800','73J':'Boeing 737-900','739':'Boeing 737-900',
        '7M8':'Boeing 737 MAX 8','7M9':'Boeing 737 MAX 9',
        '772':'Boeing 777-200','77W':'Boeing 777-300ER','773':'Boeing 777-300',
        '788':'Boeing 787-8','789':'Boeing 787-9','78X':'Boeing 787-10',
        '744':'Boeing 747-400','74H':'Boeing 747-8',
        '32A':'Airbus A320','32B':'Airbus A321','32N':'Airbus A320neo','32Q':'Airbus A321neo',
        '319':'Airbus A319','318':'Airbus A318',
        '332':'Airbus A330-200','333':'Airbus A330-300','33H':'Airbus A330-800','339':'Airbus A330-900',
        '359':'Airbus A350-900','35K':'Airbus A350-1000',
        '388':'Airbus A380-800',
        'E90':'Embraer E190','E95':'Embraer E195','E75':'Embraer E175','290':'Embraer E190-E2','295':'Embraer E195-E2',
        'CR9':'Bombardier CRJ-900','DH4':'Dash 8-Q400','AT7':'ATR 72',
    };

    // â”€â”€ Airport â†’ country code (for flags) â”€â”€
    const AIRPORT_COUNTRY = {
        LHR:'gb',LGW:'gb',STN:'gb',LTN:'gb',MAN:'gb',EDI:'gb',BHX:'gb',BRS:'gb',LCY:'gb',
        CDG:'fr',ORY:'fr',NCE:'fr',LYS:'fr',MRS:'fr',TLS:'fr',BOD:'fr',
        FRA:'de',MUC:'de',BER:'de',HAM:'de',DUS:'de',STR:'de',CGN:'de',HAJ:'de',
        MAD:'es',BCN:'es',AGP:'es',ALC:'es',PMI:'es',TFS:'es',ACE:'es',LPA:'es',IBZ:'es',SVQ:'es',VLC:'es',BIO:'es',
        FCO:'it',MXP:'it',VCE:'it',NAP:'it',BLQ:'it',PSA:'it',CTA:'it',PMO:'it',FLR:'it',BGY:'it',BRI:'it',LIN:'it',
        VIE:'at',ZRH:'ch',GVA:'ch',BSL:'ch',
        BRU:'be',LUX:'lu',
        LIS:'pt',OPO:'pt',FAO:'pt',FNC:'pt',
        ATH:'gr',SKG:'gr',HER:'gr',RHO:'gr',CFU:'gr',JMK:'gr',JTR:'gr',
        IST:'tr',SAW:'tr',AYT:'tr',ADB:'tr',DLM:'tr',ESB:'tr',
        OSL:'no',BGO:'no',TRD:'no',SVG:'no',
        CPH:'dk',ARN:'se',GOT:'se',HEL:'fi',
        WAW:'pl',KRK:'pl',WRO:'pl',GDN:'pl',
        BUD:'hu',PRG:'cz',OTP:'ro',CLJ:'ro',SOF:'bg',
        DUB:'ie',SNN:'ie',KEF:'is',RKV:'is',
        TLL:'ee',RIX:'lv',VNO:'lt',
        ZAG:'hr',SPU:'hr',DBV:'hr',BEG:'rs',LJU:'si',TIA:'al',SKP:'mk',SJJ:'ba',
        DXB:'ae',AUH:'ae',DOH:'qa',BAH:'bh',KWI:'kw',MCT:'om',RUH:'sa',JED:'sa',
        TLV:'il',AMM:'jo',BEY:'lb',CAI:'eg',CMN:'ma',RAK:'ma',TUN:'tn',ALG:'dz',
        JFK:'us',EWR:'us',LAX:'us',ORD:'us',ATL:'us',MIA:'us',SFO:'us',IAD:'us',BOS:'us',DFW:'us',
        YYZ:'ca',YVR:'ca',YUL:'ca',
        MEX:'mx',GRU:'br',EZE:'ar',BOG:'co',SCL:'cl',LIM:'pe',
        NRT:'jp',HND:'jp',KIX:'jp',PEK:'cn',PVG:'cn',CAN:'cn',HKG:'hk',
        SIN:'sg',BKK:'th',KUL:'my',CGK:'id',MNL:'ph',
        ICN:'kr',TPE:'tw',
        DEL:'in',BOM:'in',BLR:'in',MAA:'in',
        SYD:'au',MEL:'au',AKL:'nz',
        JNB:'za',CPT:'za',NBO:'ke',ADD:'et',LOS:'ng',ACC:'gh',DSS:'sn',
    };

    // â”€â”€ Clock â”€â”€
    function updateClock() {
        const now = new Date();
        const ams = now.toLocaleTimeString('nl-NL', { timeZone:'Europe/Amsterdam', hour:'2-digit', minute:'2-digit', second:'2-digit' });
        const utc = now.toUTCString().slice(17, 25);
        document.getElementById('clock').textContent = ams + ' AMS Â· ' + utc + ' UTC';
    }
    updateClock();
    setInterval(updateClock, 1000);

    // â”€â”€ ATC Audio â”€â”€
    const ATC_URLS = [
        'https://d.liveatc.net/eham_app_119055',
        'https://d.liveatc.net/eham_app',
    ];
    const audio = document.getElementById('atcAudio');
    const atcBtn = document.getElementById('atcBtn');
    const dot = document.getElementById('dot');
    const atcLabel = document.getElementById('atcLabel');
    const volSlider = document.getElementById('vol');
    const volIcon = document.getElementById('volIcon');
    let playing = false, streamIdx = 0, lofiOn = false;

    audio.volume = 0.25;

    function tryATC(idx) {
        if (idx >= ATC_URLS.length) {
            dot.className = 'status-dot error';
            atcLabel.textContent = 'âœ• unavailable';
            atcBtn.classList.remove('playing');
            playing = false;
            return;
        }
        streamIdx = idx;
        atcLabel.textContent = 'connectingâ€¦';
        audio.src = ATC_URLS[idx] + '?t=' + Date.now();
        audio.load();
        audio.play().then(() => {
            playing = true;
            dot.className = 'status-dot connected';
            atcLabel.textContent = 'â¸ LIVE Â· EHAM APP';
            atcBtn.classList.add('playing');
            if (!lofiOn) { startLofi(); lofiOn = true; }
        }).catch(() => tryATC(idx + 1));
    }

    atcBtn.addEventListener('click', () => {
        if (playing) {
            audio.pause(); audio.src = '';
            playing = false;
            dot.className = 'status-dot';
            atcLabel.textContent = 'â–¶ ATC';
            atcBtn.classList.remove('playing');
        } else {
            tryATC(0);
        }
    });

    audio.addEventListener('error', () => { if (playing) tryATC(streamIdx + 1); });
    audio.addEventListener('ended', () => { if (playing) setTimeout(() => tryATC(0), 2000); });

    volSlider.addEventListener('input', e => {
        audio.volume = e.target.value / 100;
        volIcon.textContent = e.target.value == 0 ? 'ðŸ”‡' : e.target.value < 40 ? 'ðŸ”‰' : 'ðŸ”Š';
    });

    function startLofi() {
        const start = Math.floor(Math.random() * 7200);
        document.getElementById('lofiWrap').innerHTML =
            '<iframe width="200" height="38" src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&loop=1&start=' + start + '" title="lofi" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
    }

    // â”€â”€ Radar â”€â”€
    document.getElementById('radarFrame').src =
        'https://globe.adsbexchange.com/?lat=52.309&lon=4.764&zoom=10.5&hideButtons&hideSidebar';

    // â”€â”€ Helpers â”€â”€
    function getNowAms() {
        return new Date(new Date().toLocaleString('en-US', { timeZone:'Europe/Amsterdam' }));
    }

    function getAirlineName(icao, flightName) {
        if (AIRLINES[icao]) return AIRLINES[icao];
        // Try 2-letter IATA from flightName
        if (flightName) {
            const prefix = flightName.replace(/[0-9]/g, '');
            if (AIRLINES[prefix]) return AIRLINES[prefix];
        }
        return icao || '';
    }

    function getAircraftName(code) {
        if (!code) return '';
        if (AIRCRAFT[code]) return AIRCRAFT[code];
        return code;
    }

    function getCountryCode(iata) {
        if (!iata) return null;
        const clean = iata.replace(/[^A-Z]/g, '').slice(0, 3);
        return AIRPORT_COUNTRY[clean] || null;
    }

    function statusClass(raw) {
        if (!raw) return 'b-expected';
        const s = raw.toUpperCase();
        if (s==='ARR'||s==='LND'||s==='LANDED') return 'b-landed';
        if (s==='DEL'||s==='DELAYED') return 'b-delayed';
        if (s==='CNX'||s==='CANCELLED') return 'b-cancelled';
        return 'b-expected';
    }

    function statusLabel(raw) {
        if (!raw) return 'expected';
        const s = raw.toUpperCase();
        if (s==='ARR'||s==='LND'||s==='LANDED') return 'landed';
        if (s==='DEL'||s==='DELAYED') return 'delayed';
        if (s==='CNX'||s==='CANCELLED') return 'cancelled';
        if (s==='EXP'||s==='EXPECTED'||s==='FIR'||s==='SCH') return 'expected';
        return raw.toLowerCase();
    }

    function toMinutes(t) { const [h,m] = t.split(':').map(Number); return h*60+m; }

    // â”€â”€ Render â”€â”€
    function render(flights) {
        const board = document.getElementById('board');
        const footer = document.getElementById('footer');
        const now = getNowAms();
        const nowMins = now.getHours() * 60 + now.getMinutes();

        // Filter: -5 min â†’ +30 min
        const filtered = flights.filter(f => {
            if (!f.time) return false;
            const fm = toMinutes(f.time);
            let diff = fm - nowMins;
            if (diff < -720) diff += 1440;
            if (diff > 720) diff -= 1440;
            return diff >= -5 && diff <= 30;
        });

        if (!filtered.length) {
            board.innerHTML = '<div class="fids-empty">No arrivals in the next 30 minutes</div>';
            footer.textContent = '';
            return;
        }

        board.innerHTML = filtered.map((f, i) => {
            const cc = f.countryCode;
            const flagHtml = cc
                ? `<img class="flag" src="https://flagcdn.com/w40/${cc}.png" alt="${cc}" onerror="this.style.display='none'">`
                : '';
            return `<div class="fids-row" style="animation-delay:${i*0.03}s">
                <span class="time">${f.time}</span>
                <span class="flight">${f.flight}</span>
                <span class="carrier">${f.carrier}</span>
                <span class="origin">${flagHtml}${f.city}</span>
                <span class="aircraft">${f.aircraft}</span>
                <span><span class="badge ${statusClass(f.status)}">${statusLabel(f.status)}</span></span>
            </div>`;
        }).join('');

        const to = new Date(now.getTime() + 30*60000);
        const hTo = String(to.getHours()).padStart(2,'0');
        const mTo = String(to.getMinutes()).padStart(2,'0');
        footer.textContent = `${filtered.length} flights Â· now â€“ ${hTo}:${mTo} AMS`;
    }

    // â”€â”€ Mock data â”€â”€
    function mockFlights() {
        const now = getNowAms();
        const base = now.getHours()*60 + now.getMinutes();
        const list = [];
        const samples = [
            {al:'KLM',city:'London Heathrow',cc:'gb',ac:'Boeing 787-9'},
            {al:'Turkish Airlines',city:'Istanbul',cc:'tr',ac:'Airbus A330-300'},
            {al:'Delta',city:'New York JFK',cc:'us',ac:'Boeing 767-300'},
            {al:'Air France',city:'Paris CDG',cc:'fr',ac:'Airbus A320'},
            {al:'Lufthansa',city:'Frankfurt',cc:'de',ac:'Airbus A321neo'},
            {al:'Emirates',city:'Dubai',cc:'ae',ac:'Boeing 777-300ER'},
            {al:'British Airways',city:'London City',cc:'gb',ac:'Embraer E190'},
            {al:'SAS Scandinavian',city:'Copenhagen',cc:'dk',ac:'Airbus A320neo'},
            {al:'Transavia',city:'Barcelona',cc:'es',ac:'Boeing 737-800'},
            {al:'easyJet',city:'Nice',cc:'fr',ac:'Airbus A320'},
            {al:'United',city:'Washington IAD',cc:'us',ac:'Boeing 787-10'},
            {al:'Qatar Airways',city:'Doha',cc:'qa',ac:'Airbus A350-900'},
        ];
        for (let i = -4; i <= 32; i += 3) {
            const mins = base + i;
            const h = String(Math.floor(((mins%1440)+1440)%1440/60)).padStart(2,'0');
            const m = String(((mins%60)+60)%60).padStart(2,'0');
            const s = samples[Math.floor(Math.random()*samples.length)];
            list.push({
                time: h+':'+m,
                flight: 'KL'+Math.floor(Math.random()*9000+1000),
                carrier: s.al,
                city: s.city,
                countryCode: s.cc,
                aircraft: s.ac,
                status: i < 0 ? 'landed' : (Math.random() > 0.85 ? 'delayed' : 'expected'),
            });
        }
        return list;
    }

    // â”€â”€ Fetch â”€â”€
    let cached = null, lastFetch = Date.now();

    function fetchFlights() {
        const spin = document.getElementById('spin');
        const meta = document.getElementById('metaText');
        spin.classList.add('on');
        meta.textContent = 'updatingâ€¦';

        fetch('/.netlify/functions/arrivals')
            .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
            .then(data => {
                const raw = data.flights || [];
                cached = raw.map(f => {
                    let time = f.scheduleTime?.slice(0,5) || '';
                    if (f.scheduleDateTime) {
                        const d = new Date(f.scheduleDateTime);
                        const a = new Date(d.toLocaleString('en-US',{timeZone:'Europe/Amsterdam'}));
                        time = String(a.getHours()).padStart(2,'0') + ':' + String(a.getMinutes()).padStart(2,'0');
                    }

                    const iata = (f.route?.destinations||[])[0] || '';
                    const iataClean = iata.replace(/[^A-Z]/gi,'').slice(0,3).toUpperCase();
                    const cc = f.cityInfo?.country?.toLowerCase() || getCountryCode(iataClean);
                    const city = f.cityInfo?.city || iata || '';
                    const carrier = getAirlineName(f.prefixICAO, f.flightName);
                    const acCode = f.aircraftType?.iataMain || f.aircraftType?.iataSub || '';
                    const aircraft = getAircraftName(acCode);
                    const status = (f.publicFlightState?.flightStates||[])[0] || 'expected';

                    return { time, flight: f.flightName||'', carrier, city, countryCode: cc, aircraft, status };
                });

                render(cached.length ? cached : mockFlights());
                lastFetch = Date.now();
                spin.classList.remove('on');
                meta.textContent = 'just now';
            })
            .catch(() => {
                render(cached || mockFlights());
                spin.classList.remove('on');
                meta.textContent = cached ? 'cached' : 'demo';
            });
    }

    fetchFlights();
    setInterval(fetchFlights, 5 * 60 * 1000);
    setInterval(() => render(cached || mockFlights()), 60000); // Slide time window

    setInterval(() => {
        const m = Math.floor((Date.now() - lastFetch) / 60000);
        if (m > 0) document.getElementById('metaText').textContent = m + 'm ago';
    }, 30000);

})();
</script>
</body>
</html>
